<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Dashboard Secrétaire - Candidapp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #a855f7 100%);
        }

        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <a href="/secretaire/dashboard" class="flex items-center space-x-2">
                    <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-900">Candidapp</span>
                    <span class="hidden sm:inline-block text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full font-medium">Secrétariat</span>
                </a>

                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-6">
                    <a id="nav-dashboard" href="/secretaire/dashboard" class="text-primary-600 font-semibold border-b-2 border-primary-600 pb-1">Tableau de bord</a>
                    <a id="nav-etudiants" href="/secretaire/etudiants" class="text-gray-600 hover:text-primary-600 transition">Gestion étudiants</a>
                    <a id="nav-rc" href="/secretaire/validation-rc" class="text-gray-600 hover:text-primary-600 transition flex items-center space-x-1">
                        <span>Validation RC</span>
                        <span id="menuBadgeRC" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden"></span>
                    </a>
                    <a id="nav-offres" href="/offres" class="text-gray-600 hover:text-primary-600 transition">Offres</a>
                    <a id="nav-profil" href="/secretaire/profil" class="text-gray-600 hover:text-primary-600 transition">Mon profil</a>
                </div>

                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <div id="userBadge" class="hidden md:flex items-center space-x-2 bg-primary-50 px-3 py-1.5 rounded-full">
                        <div class="w-8 h-8 bg-primary-600 rounded-full flex items-center justify-center">
                            <span id="userInitial" class="text-white font-semibold text-sm">SC</span>
                        </div>
                        <span id="userEmailBadge" class="text-primary-700 font-medium text-sm max-w-[120px] truncate"></span>
                    </div>
                    <button id="logoutBtn" class="flex items-center space-x-2 text-gray-600 hover:text-red-600 font-medium transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span class="hidden sm:inline">Déconnexion</span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Page Header -->
    <section class="gradient-bg text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">Espace Secrétaire</h1>
                        <p class="text-purple-200 mt-1">Vue d'ensemble des activités et tâches</p>
                    </div>
                </div>
                <button id="btnDeclarerConges"
                    class="hidden md:flex items-center space-x-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm px-5 py-3 rounded-lg font-semibold transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span>Déclarer congés</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Étudiants inscrits -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statEtudiants">-</h3>
                <p class="text-sm text-gray-500">Étudiants inscrits</p>
            </div>

            <!-- RC à valider -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statRC">-</h3>
                <p class="text-sm text-gray-500">RC à valider</p>
            </div>

            <!-- Étudiants en recherche -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statRecherche">-</h3>
                <p class="text-sm text-gray-500">Étudiants en recherche</p>
            </div>

            <!-- Entreprises Partenaires -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statEntreprises">-</h3>
                <p class="text-sm text-gray-500">Entreprises Partenaires</p>
            </div>
        </div>

        <!-- RC en attente de validation -->
        <div id="validation-rc" class="bg-white rounded-xl shadow-sm mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">RC en attente de validation</h3>
            </div>
            <div class="divide-y divide-gray-200" id="rcList"></div>

            <div id="rcLoading" class="px-6 py-6 text-sm text-gray-500">
                Chargement des attestations...
            </div>
            <div id="rcEmpty" class="hidden px-6 py-6 text-sm text-gray-500">
                Aucune attestation RC en attente.
            </div>
        </div>

        <!-- RC expirées - Action requise -->
        <div class="bg-white rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">RC expirées - Action requise</h3>
            </div>
            <div class="divide-y divide-gray-200">
                <!-- Expired RC Item 1 (Mock Data) -->
                <div class="px-6 py-4 bg-red-50 flex items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <span class="text-red-600 font-semibold text-sm">SB</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">Sophie Bernard</h4>
                            <p class="text-xs text-red-600 font-medium">⚠️ RC expirée depuis 15 jours</p>
                        </div>
                    </div>
                    <button
                        class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded-lg transition">
                        Contacter l'étudiant
                    </button>
                </div>

                <!-- Expired RC Item 2 (Mock Data) -->
                <div class="px-6 py-4 bg-red-50 flex items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                            <span class="text-red-600 font-semibold text-sm">TD</span>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-900">Thomas Durand</h4>
                            <p class="text-xs text-red-600 font-medium">⚠️ RC expirée depuis 8 jours</p>
                        </div>
                    </div>
                    <button
                        class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded-lg transition">
                        Contacter l'étudiant
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Déclarer congés -->
    <div id="modalConges" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Déclarer un congé</h3>
                <button id="closeModalConges" class="p-2 hover:bg-gray-100 rounded-lg">✕</button>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-700">Date début</label>
                        <input id="congeDateDebut" type="date" class="mt-1 w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="text-sm text-gray-700">Date fin</label>
                        <input id="congeDateFin" type="date" class="mt-1 w-full border rounded-lg px-3 py-2">
                    </div>
                </div>

                <div>
                    <label class="text-sm text-gray-700">Remplaçant (enseignant)</label>
                    <select id="congeRemplacant" class="mt-1 w-full border rounded-lg px-3 py-2">
                        <option value="">Aucun</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Le remplaçant pourra utiliser les fonctions secrétaire pendant la période.</p>
                </div>

                <div>
                    <label class="text-sm text-gray-700">Motif (optionnel)</label>
                    <textarea id="congeMotif" rows="3" class="mt-1 w-full border rounded-lg px-3 py-2"></textarea>
                </div>

                <div id="congeMsg" class="hidden text-sm"></div>

                <div class="flex justify-end gap-2 pt-2">
                    <button id="cancelConges" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Annuler</button>
                    <button id="submitConges" class="px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700">Déclarer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ==================== SESSION ====================
    let user = null;
    try {
        user = JSON.parse(sessionStorage.getItem("user") || "null");
    } catch {
        user = null;
    }

    if (!user || !user.id) window.location.href = "/login.html";
    const userId = user.id;

    // ==================== UI INIT ====================
    function initUserUI() {
        const email = user?.email || '';
        const nom = user?.nom || '';
        const initial = (nom[0] || email[0] || 'S').toUpperCase();

        document.getElementById('userInitial').textContent = initial;
        document.getElementById('userEmailBadge').textContent = email;
    }

    // ==================== CHARGEMENT INITIAL ====================
    window.addEventListener('DOMContentLoaded', () => {
        initUserUI();
        loadStats();
        loadAttestations();
        setupEventListeners();
        setActiveMenu();
        if (window.location.hash === "#validation-rc") {
            setTimeout(() => document.getElementById("validation-rc")?.scrollIntoView({ behavior: "smooth" }), 200);
        }
    });

    function setupEventListeners() {
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            sessionStorage.clear();
            window.location.href = '/login';
        });
    }

    function setActiveMenu() {
        const navItems = ['nav-dashboard', 'nav-etudiants', 'nav-rc', 'nav-profil'];
        const path = window.location.pathname;

        navItems.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;

            el.classList.remove('text-primary-600', 'font-semibold', 'border-b-2', 'border-primary-600', 'pb-1');
            el.classList.add('text-gray-600');
        });

        let activeId = 'nav-dashboard';
        if (path.includes('/secretaire/profil')) activeId = 'nav-profil';
        else if (path.includes('/secretaire/etudiants')) activeId = 'nav-etudiants';
        else if (path.includes('/secretaire/validation-rc')) activeId = 'nav-rc';

        const activeEl = document.getElementById(activeId);
        if (activeEl) {
            activeEl.classList.remove('text-gray-600');
            activeEl.classList.add('text-primary-600', 'font-semibold', 'border-b-2', 'border-primary-600', 'pb-1');
        }
    }

    // ==================== CHARGEMENT DES STATS ====================
    async function loadStats() {
        try {
            const response = await fetch('/api/dashboard/secretaire/stats');
            const data = await response.json();
            if (!data.ok) return;

            const stats = data.stats;
            document.getElementById('statEtudiants').textContent = stats.nb_etudiants_total || 0;
            document.getElementById('statRC').textContent = stats.nb_attestations_a_valider || 0;
            document.getElementById('statRecherche').textContent = stats.nb_etudiants_en_recherche || 0;
            document.getElementById('statEntreprises').textContent = stats.nb_entreprises_partenaires || 0;

        } catch (error) {
            console.error('Erreur stats:', error);
        }
    }

    // ==================== RC : LISTE ====================
    async function loadAttestations() {
        const loading = document.getElementById("rcLoading");
        const empty = document.getElementById("rcEmpty");
        const list = document.getElementById("rcList");

        loading.classList.remove("hidden");
        empty.classList.add("hidden");
        list.innerHTML = "";

        try {
            const res = await fetch(`/api/dashboard/secretaire/attestations?userId=${userId}`);
            const data = await res.json();

            loading.classList.add("hidden");

            if (!data.ok) {
                console.error(data.error || "Erreur chargement attestations");
                empty.textContent = "Erreur lors du chargement des attestations.";
                empty.classList.remove("hidden");
                return;
            }

            const attestations = data.attestations || [];

            // Badge menu
            const badge = document.getElementById("menuBadgeRC");
            const n = attestations.length;
            if (n > 0) { badge.textContent = String(n); badge.classList.remove("hidden"); }
            else { badge.classList.add("hidden"); }

            if (attestations.length === 0) {
                empty.classList.remove("hidden");
                return;
            }

            attestations.forEach(a => {
                list.appendChild(renderAttestationRow(a));
            });

        } catch (e) {
            loading.classList.add("hidden");
            empty.textContent = "Erreur technique lors du chargement.";
            empty.classList.remove("hidden");
            console.error(e);
        }
    }

    function renderAttestationRow(a) {
        const etudiantId = a.etudiant_id;
        const nom = `${a.prenom || ''} ${a.nom || ''}`.trim() || `Étudiant #${etudiantId}`;
        const promo = a.promo ? `Promo ${a.promo}` : '';
        const dateDepot = a.date_depot ? new Date(a.date_depot).toLocaleDateString('fr-FR') : '—';
        const fichier = a.fichier_url ? shortFileName(a.fichier_url) : 'fichier indisponible';
        const initials = getInitials(a.prenom, a.nom);

        const row = document.createElement("div");
        row.className = "px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition";

        row.innerHTML = `
        <div class="flex items-center space-x-4 flex-1">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <span class="text-blue-600 font-semibold text-sm">${initials}</span>
            </div>
            <div class="flex-1">
                <h4 class="text-sm font-medium text-gray-900">${escapeHtml(nom)}</h4>
                <p class="text-xs text-gray-500">${escapeHtml(promo)} • Soumis le ${escapeHtml(dateDepot)}</p>
            </div>
            <div class="flex items-center space-x-2">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <span class="text-sm text-gray-600">${escapeHtml(fichier)}</span>
            </div>
        </div>

        <div class="flex items-center space-x-2 ml-4">
            <button data-action="valider" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition">
                Valider
            </button>
            <button data-action="refuser" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition">
                Refuser
            </button>
        </div>
        `;

        row.querySelector('[data-action="valider"]').addEventListener("click", () => onValider(etudiantId));
        row.querySelector('[data-action="refuser"]').addEventListener("click", () => onRefuser(etudiantId));

        return row;
    }

    // ==================== RC : ACTIONS ====================
    async function onValider(etudiantId) {
        if (!confirm("Valider cette attestation RC ?")) return;

        try {
            const res = await fetch(`/api/dashboard/secretaire/attestations/${etudiantId}/valider?userId=${userId}`, {
                method: "POST"
            });
            const data = await res.json();

            if (!data.ok) {
                alert(data.error || "Erreur validation");
                return;
            }

            await loadStats();
            await loadAttestations();
        } catch (e) {
            console.error(e);
            alert("Erreur technique validation");
        }
    }

    async function onRefuser(etudiantId) {
        const motif = prompt("Motif de refus (optionnel) :", "");
        if (motif === null) return;

        try {
            const res = await fetch(`/api/dashboard/secretaire/attestations/${etudiantId}/refuser?userId=${userId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ motif_refus: motif || null })
            });
            const data = await res.json();

            if (!data.ok) {
                alert(data.error || "Erreur refus");
                return;
            }

            await loadStats();
            await loadAttestations();
        } catch (e) {
            console.error(e);
            alert("Erreur technique refus");
        }
    }

    // ==================== HELPERS ====================
    function getInitials(prenom, nom) {
        const p = (prenom || "").trim();
        const n = (nom || "").trim();
        return ((p[0] || '') + (n[0] || '')).toUpperCase() || "??";
    }

    function shortFileName(url) {
        try {
            if (typeof url === "string" && url.startsWith("data:")) return "attestation_rc.pdf";
            const parts = String(url).split("/");
            return parts[parts.length - 1] || "attestation_rc.pdf";
        } catch {
            return "attestation_rc.pdf";
        }
    }

    function escapeHtml(str) {
        return String(str ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // ==================== CONGÉS : MODAL ====================
    const modalConges = document.getElementById('modalConges');
    const btnConges = document.getElementById('btnDeclarerConges');
    const closeModalConges = document.getElementById('closeModalConges');
    const cancelConges = document.getElementById('cancelConges');
    const submitConges = document.getElementById('submitConges');
    const congeMsg = document.getElementById('congeMsg');

    function openCongesModal() {
        modalConges.classList.remove('hidden');
        modalConges.classList.add('flex');
        congeMsg.classList.add('hidden');
        loadRemplacants();
    }

    function closeCongesModal() {
        modalConges.classList.add('hidden');
        modalConges.classList.remove('flex');
    }

    btnConges?.addEventListener('click', openCongesModal);
    closeModalConges?.addEventListener('click', closeCongesModal);
    cancelConges?.addEventListener('click', closeCongesModal);

    async function loadRemplacants() {
        const select = document.getElementById('congeRemplacant');
        select.innerHTML = `<option value="">Aucun</option>`;

        try {
            const r = await fetch(`/api/dashboard/secretaire/conges/remplacants?userId=${userId}`);
            const data = await r.json();
            if (!data.ok) return;

            for (const e of data.remplacants || []) {
                const opt = document.createElement('option');
                opt.value = e.utilisateur_id;
                opt.textContent = `${e.nom || 'Enseignant'} (${e.email})`;
                select.appendChild(opt);
            }
        } catch (e) {
            console.error(e);
        }
    }

    submitConges?.addEventListener('click', async () => {
        const dateDebut = document.getElementById('congeDateDebut').value;
        const dateFin = document.getElementById('congeDateFin').value;
        const remplacantUtilisateurId = document.getElementById('congeRemplacant').value || null;
        const motif = document.getElementById('congeMotif').value || null;

        congeMsg.classList.remove('hidden');
        congeMsg.className = 'text-sm text-gray-600';

        if (!dateDebut || !dateFin) {
            congeMsg.className = 'text-sm text-red-600';
            congeMsg.textContent = 'Veuillez saisir une date de début et une date de fin.';
            return;
        }

        try {
            const resp = await fetch(`/api/dashboard/secretaire/conges?userId=${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dateDebut, dateFin, remplacantUtilisateurId, motif })
            });

            const data = await resp.json();
            if (!resp.ok || !data.ok) {
                congeMsg.className = 'text-sm text-red-600';
                congeMsg.textContent = data.error || 'Erreur lors de la déclaration du congé.';
                return;
            }

            congeMsg.className = 'text-sm text-green-600';
            congeMsg.textContent = `Congé déclaré (id: ${data.congeId}).`;

            setTimeout(closeCongesModal, 900);
        } catch (e) {
            console.error(e);
            congeMsg.className = 'text-sm text-red-600';
            congeMsg.textContent = 'Erreur technique.';
        }
    });
    </script>

</body>
</html>

