<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashboard Secrétaire - Candidapp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #a855f7 100%);
        }

        .sidebar {
            width: 280px;
            min-height: 100vh;
        }

        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .menu-item {
            transition: all 0.2s ease;
        }

        .menu-item:hover {
            background-color: rgba(99, 102, 241, 0.1);
            transform: translateX(4px);
        }

        .menu-item.active {
            background-color: rgba(99, 102, 241, 0.15);
            border-left: 4px solid #4f46e5;
            font-weight: 600;
        }

        .badge-pending {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-urgent {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body class="bg-gray-50">

    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar bg-white shadow-lg fixed left-0 top-0 flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Candidapp</h1>
                        <p class="text-xs text-gray-500">Secrétariat</p>
                    </div>
                </div>
            </div>

            <!-- Menu Navigation -->
            <nav class="flex-1 py-6">
                <div class="px-4 space-y-2">
                    <a href="/secretaire/dashboard"
                        class="menu-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        <span>Tableau de bord</span>
                    </a>

                    <a href="/secretaire/etudiants" class="menu-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span>Gestion étudiants</span>
                    </a>

                    <a href="#" class="menu-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Validation RC</span>
                        <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">3</span>
                    </a>

                    <a href="#" class="menu-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <span>Support</span>
                    </a>
                </div>
            </nav>

            <!-- Déconnexion -->
            <div class="p-4 border-t">
                <button id="logoutBtn"
                    class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    <span>Déconnexion</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-[280px]">
            <!-- Header -->
            <header class="bg-white shadow-sm sticky top-0 z-10">
                <div class="px-8 py-4 flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Espace Secrétaire</h2>
                        <p class="text-sm text-gray-500 mt-1">Vue d'ensemble des activités et tâches</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button
                            class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-medium transition flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            <span>Déclarer congés</span>
                        </button>
                        <button class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        <div class="flex items-center space-x-2">
                            <div class="w-10 h-10 bg-primary-600 rounded-full flex items-center justify-center">
                                <span class="text-white font-semibold">SC</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="p-8">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Étudiants inscrits -->
                    <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statEtudiants">-</h3>
                        <p class="text-sm text-gray-500">Étudiants inscrits</p>
                    </div>

                    <!-- RC à valider -->
                    <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statRC">-</h3>
                        <p class="text-sm text-gray-500">RC à valider</p>
                    </div>

                    <!-- Étudiants en recherche -->
                    <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statRecherche">-</h3>
                        <p class="text-sm text-gray-500">Étudiants en recherche</p>
                    </div>

                    <!-- Entreprises Partenaires -->
                    <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statEntreprises">-</h3>
                        <p class="text-sm text-gray-500">Entreprises Partenaires</p>
                    </div>
                </div>

                <!-- RC en attente de validation -->
                <div class="bg-white rounded-xl shadow-sm mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">RC en attente de validation</h3>
                    </div>
                    <div class="divide-y divide-gray-200" id="rcList"></div>

                    <div id="rcLoading" class="px-6 py-6 text-sm text-gray-500">
                        Chargement des attestations...
                    </div>
                    <div id="rcEmpty" class="hidden px-6 py-6 text-sm text-gray-500">
                        Aucune attestation RC en attente.
                    </div>

                </div>

                <!-- RC expirées - Action requise -->
                <div class="bg-white rounded-xl shadow-sm">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">RC expirées - Action requise</h3>
                    </div>
                    <div class="divide-y divide-gray-200">
                        <!-- Expired RC Item 1 (Mock Data) -->
                        <div class="px-6 py-4 bg-red-50 flex items-center justify-between">
                            <div class="flex items-center space-x-4 flex-1">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                    <span class="text-red-600 font-semibold text-sm">SB</span>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-sm font-medium text-gray-900">Sophie Bernard</h4>
                                    <p class="text-xs text-red-600 font-medium">⚠️ RC expirée depuis 15 jours</p>
                                </div>
                            </div>
                            <button
                                class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded-lg transition">
                                Contacter l'étudiant
                            </button>
                        </div>

                        <!-- Expired RC Item 2 (Mock Data) -->
                        <div class="px-6 py-4 bg-red-50 flex items-center justify-between">
                            <div class="flex items-center space-x-4 flex-1">
                                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                                    <span class="text-red-600 font-semibold text-sm">TD</span>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-sm font-medium text-gray-900">Thomas Durand</h4>
                                    <p class="text-xs text-red-600 font-medium">⚠️ RC expirée depuis 8 jours</p>
                                </div>
                            </div>
                            <button
                                class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded-lg transition">
                                Contacter l'étudiant
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
    // ==================== SESSION ====================
    const user = JSON.parse(sessionStorage.getItem("user") || "null");
    if (!user || !user.id) window.location.href = "/login.html";
    const userId = user.id;

    // ==================== CHARGEMENT INITIAL ====================
    window.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadAttestations();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('logoutBtn').addEventListener('click', () => {
        sessionStorage.clear();
        window.location.href = '/login.html';
        });
    }

    // ==================== CHARGEMENT DES STATS ====================
    async function loadStats() {
        try {
        const response = await fetch('/api/dashboard/secretaire/stats');
        const data = await response.json();
        if (!data.ok) return;

        const stats = data.stats;
        document.getElementById('statEtudiants').textContent = stats.nb_etudiants_total || 0;
        document.getElementById('statRC').textContent = stats.nb_attestations_a_valider || 0;
        document.getElementById('statRecherche').textContent = stats.nb_etudiants_en_recherche || 0;
        document.getElementById('statEntreprises').textContent = stats.nb_entreprises_partenaires || 0;
        } catch (error) {
        console.error('Erreur stats:', error);
        }
    }

    // ==================== RC : LISTE ====================
    async function loadAttestations() {
        const loading = document.getElementById("rcLoading");
        const empty = document.getElementById("rcEmpty");
        const list = document.getElementById("rcList");

        loading.classList.remove("hidden");
        empty.classList.add("hidden");
        list.innerHTML = "";

        try {
        const res = await fetch(`/api/dashboard/secretaire/attestations?userId=${userId}`);
        const data = await res.json();

        loading.classList.add("hidden");

        if (!data.ok) {
            console.error(data.error || "Erreur chargement attestations");
            empty.textContent = "Erreur lors du chargement des attestations.";
            empty.classList.remove("hidden");
            return;
        }

        const attestations = data.attestations || [];
        if (attestations.length === 0) {
            empty.classList.remove("hidden");
            return;
        }

        attestations.forEach(a => {
            list.appendChild(renderAttestationRow(a));
        });

        // Mettre à jour badge menu (optionnel)
        // document.querySelector(".menu-item span.ml-auto")?.textContent = attestations.length;

        } catch (e) {
        loading.classList.add("hidden");
        empty.textContent = "Erreur technique lors du chargement.";
        empty.classList.remove("hidden");
        console.error(e);
        }
    }

    function renderAttestationRow(a) {
        // champs attendus depuis v_attestations_rc_a_valider :
        // etudiant_id, nom, prenom, promo, fichier_url, date_depot, statut ...
        const etudiantId = a.etudiant_id;
        const nom = `${a.prenom || ''} ${a.nom || ''}`.trim() || `Étudiant #${etudiantId}`;
        const promo = a.promo ? `Promo ${a.promo}` : '';
        const dateDepot = a.date_depot ? new Date(a.date_depot).toLocaleDateString('fr-FR') : '—';
        const fichier = a.fichier_url ? shortFileName(a.fichier_url) : 'fichier indisponible';
        const initials = getInitials(a.prenom, a.nom);

        const row = document.createElement("div");
        row.className = "px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition";

        row.innerHTML = `
        <div class="flex items-center space-x-4 flex-1">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
            <span class="text-blue-600 font-semibold text-sm">${initials}</span>
            </div>
            <div class="flex-1">
            <h4 class="text-sm font-medium text-gray-900">${escapeHtml(nom)}</h4>
            <p class="text-xs text-gray-500">${escapeHtml(promo)} • Soumis le ${escapeHtml(dateDepot)}</p>
            </div>
            <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            <span class="text-sm text-gray-600">${escapeHtml(fichier)}</span>
            </div>
        </div>

        <div class="flex items-center space-x-2 ml-4">
            <button data-action="valider" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition">
            Valider
            </button>
            <button data-action="refuser" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition">
            Refuser
            </button>
        </div>
        `;

        // Handlers boutons
        row.querySelector('[data-action="valider"]').addEventListener("click", () => onValider(etudiantId));
        row.querySelector('[data-action="refuser"]').addEventListener("click", () => onRefuser(etudiantId));

        return row;
    }

    // ==================== RC : ACTIONS ====================
    async function onValider(etudiantId) {
        if (!confirm("Valider cette attestation RC ?")) return;

        try {
        const res = await fetch(`/api/dashboard/secretaire/attestations/${etudiantId}/valider?userId=${userId}`, {
            method: "POST"
        });
        const data = await res.json();

        if (!data.ok) {
            alert(data.error || "Erreur validation");
            return;
        }

        // refresh
        await loadStats();
        await loadAttestations();
        } catch (e) {
        console.error(e);
        alert("Erreur technique validation");
        }
    }

    async function onRefuser(etudiantId) {
        const motif = prompt("Motif de refus (optionnel) :", "");
        if (motif === null) return; // annuler

        try {
        const res = await fetch(`/api/dashboard/secretaire/attestations/${etudiantId}/refuser?userId=${userId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ motif_refus: motif || null })
        });
        const data = await res.json();

        if (!data.ok) {
            alert(data.error || "Erreur refus");
            return;
        }

        // refresh
        await loadStats();
        await loadAttestations();
        } catch (e) {
        console.error(e);
        alert("Erreur technique refus");
        }
    }

    // ==================== HELPERS ====================
    function getInitials(prenom, nom) {
        const p = (prenom || "").trim();
        const n = (nom || "").trim();
        return ((p[0] || '') + (n[0] || '')).toUpperCase() || "??";
    }

    function shortFileName(url) {
        try {
        // si c'est un dataURL, juste afficher "PDF"
        if (typeof url === "string" && url.startsWith("data:")) return "attestation_rc.pdf";
        const parts = String(url).split("/");
        return parts[parts.length - 1] || "attestation_rc.pdf";
        } catch {
        return "attestation_rc.pdf";
        }
    }

    function escapeHtml(str) {
        return String(str ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    </script>

</body>

</html>