<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Dashboard Secrétaire - Candidapp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #a855f7 100%);
        }

        .stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <a href="/" class="flex items-center space-x-2">
                    <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-900">Candidapp</span>
                    <span
                        class="hidden sm:inline-block text-xs bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full font-medium">Secrétariat</span>
                </a>

                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-6">
                    <a id="nav-dashboard" href="/secretaire/dashboard"
                        class="text-primary-600 font-semibold border-b-2 border-primary-600 pb-1">Tableau de bord</a>
                    <a id="nav-etudiants" href="/secretaire/etudiants"
                        class="text-gray-600 hover:text-primary-600 transition">Gestion étudiants</a>
                    <a id="nav-rc" href="/secretaire/validation-rc"
                        class="text-gray-600 hover:text-primary-600 transition flex items-center space-x-1">
                        <span>Validation RC</span>
                        <span id="menuBadgeRC"
                            class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden"></span>
                    </a>
                    <a id="nav-offres" href="/offres" class="text-gray-600 hover:text-primary-600 transition">Offres</a>

                </div>

                <!-- User Menu -->
                <div class="flex items-center space-x-4">
                    <!-- Bouton retour enseignant (visible uniquement pour les enseignants remplaçants) -->
                    <a id="btnRetourEnseignant" href="/enseignant/dashboard"
                        class="hidden items-center space-x-1.5 px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white text-sm rounded-lg font-medium transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                        <span>Retour enseignant</span>
                    </a>
                    <div id="userBadge"
                        class="hidden md:flex items-center space-x-2 bg-primary-50 px-3 py-1.5 rounded-full">
                        <div class="w-8 h-8 bg-primary-600 rounded-full flex items-center justify-center">
                            <span id="userInitial" class="text-white font-semibold text-sm">SC</span>
                        </div>
                        <span id="userEmailBadge"
                            class="text-primary-700 font-medium text-sm max-w-[120px] truncate"></span>
                    </div>
                    <button id="logoutBtn"
                        class="flex items-center space-x-2 text-gray-600 hover:text-red-600 font-medium transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span class="hidden sm:inline">Déconnexion</span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Page Header -->
    <section class="gradient-bg text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">Espace Secrétaire</h1>
                        <p class="text-purple-200 mt-1">Vue d'ensemble des activités et tâches</p>
                    </div>
                </div>
                <button id="btnDeclarerConges"
                    class="hidden md:flex items-center space-x-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm px-5 py-3 rounded-lg font-semibold transition">
                    <svg id="congeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span id="congeLabel">Mode congé</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Étudiants inscrits -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statEtudiants">-</h3>
                <p class="text-sm text-gray-500">Étudiants inscrits</p>
            </div>

            <!-- RC à valider -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statRC">-</h3>
                <p class="text-sm text-gray-500">RC à valider</p>
            </div>

            <!-- Étudiants en recherche -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statRecherche">-</h3>
                <p class="text-sm text-gray-500">Étudiants en recherche</p>
            </div>

            <!-- Entreprises Partenaires -->
            <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-gray-900 mb-1" id="statEntreprises">-</h3>
                <p class="text-sm text-gray-500">Entreprises Partenaires</p>
            </div>
        </div>

        <!-- RC en attente de validation -->
        <div id="validation-rc" class="bg-white rounded-xl shadow-sm mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">RC en attente de validation</h3>
            </div>
            <div class="divide-y divide-gray-200" id="rcList"></div>

            <div id="rcLoading" class="px-6 py-6 text-sm text-gray-500">
                Chargement des attestations...
            </div>
            <div id="rcEmpty" class="hidden px-6 py-6 text-sm text-gray-500">
                Aucune attestation RC en attente.
            </div>
        </div>

        <!-- RC expirées - Action requise (Dynamique) -->
        <div class="bg-white rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">RC expirées - Action requise</h3>
                <span id="rcExpireesBadge"
                    class="hidden text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-semibold">
                    0
                </span>
            </div>

            <div id="rcExpireesLoading" class="px-6 py-6 text-sm text-gray-500">
                Chargement des RC expirées...
            </div>

            <div id="rcExpireesEmpty" class="hidden px-6 py-6 text-sm text-gray-500">
                Aucune attestation RC expirée.
            </div>

            <div id="rcExpireesList" class="divide-y divide-gray-200"></div>
        </div>
    </main>

    <!-- Modal Mode congé (toggle simplifié) -->
    <div id="modalConges" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Mode congé</h3>
                <button id="closeModalConges" class="p-2 hover:bg-gray-100 rounded-lg">✕</button>
            </div>

            <div class="space-y-4">
                <!-- Statut actuel -->
                <div id="congeStatutBox" class="p-4 rounded-lg bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-medium text-gray-900">Statut actuel</p>
                            <p id="congeStatutText" class="text-sm text-gray-600">Chargement...</p>
                        </div>
                        <div id="congeStatutBadge"
                            class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700">
                            Actif
                        </div>
                    </div>
                </div>

                <!-- Liste des remplaçants automatiques -->
                <div>
                    <p class="text-sm text-gray-700 font-medium mb-2">Remplaçants automatiques (enseignants référents) :
                    </p>
                    <div id="remplacantsList" class="space-y-2 text-sm text-gray-600">
                        <p class="text-gray-400">Chargement...</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">En mode congé, ces enseignants pourront effectuer les tâches
                        administratives à votre place.</p>
                </div>

                <div id="congeMsg" class="hidden text-sm"></div>

                <div class="flex justify-end gap-2 pt-4 border-t">
                    <button id="cancelConges" class="px-4 py-2 rounded-lg border hover:bg-gray-50">Fermer</button>
                    <button id="toggleCongeBtn" class="px-4 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700">
                        Activer le mode congé
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== SESSION ====================
        let user = null;
        try {
            user = JSON.parse(sessionStorage.getItem("user") || "null");
        } catch {
            user = null;
        }

        if (!user || !user.id) window.location.href = "/login.html";
        const userId = user.id;

        // Détection si c'est un enseignant remplaçant (et non un vrai secrétaire)
        const isEnseignantRemplacant = user?.role === 'ENSEIGNANT';

        // ==================== UI INIT ====================
        function initUserUI() {
            const email = user?.email || '';
            const nom = user?.nom || '';
            const initial = (nom[0] || email[0] || 'S').toUpperCase();

            document.getElementById('userInitial').textContent = initial;
            document.getElementById('userEmailBadge').textContent = email;

            // Si c'est un enseignant remplaçant, adapter l'interface
            if (isEnseignantRemplacant) {
                // Afficher le bouton retour enseignant
                const btnRetour = document.getElementById('btnRetourEnseignant');
                if (btnRetour) {
                    btnRetour.classList.remove('hidden');
                    btnRetour.classList.add('flex');
                }

                // Masquer le lien "Mon profil" dans la navigation
                const navProfil = document.getElementById('nav-profil');
                if (navProfil) {
                    navProfil.style.display = 'none';
                }

                // Masquer le bouton "Mode congé"
                const btnConges = document.getElementById('btnDeclarerConges');
                if (btnConges) {
                    btnConges.style.display = 'none';
                }

                // Ajouter un badge "Mode remplacement" dans le header
                const badge = document.querySelector('.hidden.sm\\:inline-block.text-xs.bg-primary-100');
                if (badge) {
                    badge.textContent = 'Mode remplacement';
                    badge.className = 'hidden sm:inline-block text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-medium';
                }
            }
        }

        // ==================== CHARGEMENT INITIAL ====================
        window.addEventListener('DOMContentLoaded', () => {
            initUserUI();
            loadStats();
            loadAttestations();
            loadAttestationsExpirees();
            // Ne charger le statut congé que si c'est un vrai secrétaire
            if (!isEnseignantRemplacant) {
                loadInitialCongeStatus();
            }
            setupEventListeners();
            setActiveMenu();
            if (window.location.hash === "#validation-rc") {
                setTimeout(() => document.getElementById("validation-rc")?.scrollIntoView({ behavior: "smooth" }), 200);
            }
        });

        function setupEventListeners() {
            document.getElementById('logoutBtn').addEventListener('click', () => {
                Auth.logout('Vous avez été déconnecté.');
            });
        }

        function setActiveMenu() {
            const navItems = ['nav-dashboard', 'nav-etudiants', 'nav-rc', 'nav-profil'];
            const path = window.location.pathname;

            navItems.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;

                el.classList.remove('text-primary-600', 'font-semibold', 'border-b-2', 'border-primary-600', 'pb-1');
                el.classList.add('text-gray-600');
            });

            let activeId = 'nav-dashboard';
            if (path.includes('/secretaire/etudiants')) activeId = 'nav-etudiants';
            else if (path.includes('/secretaire/validation-rc')) activeId = 'nav-rc';

            const activeEl = document.getElementById(activeId);
            if (activeEl) {
                activeEl.classList.remove('text-gray-600');
                activeEl.classList.add('text-primary-600', 'font-semibold', 'border-b-2', 'border-primary-600', 'pb-1');
            }
        }

        // ==================== CHARGEMENT DES STATS ====================
        async function loadStats() {
            try {
                const response = await fetch('/api/dashboard/secretaire/stats');
                const data = await response.json();
                if (!data.ok) return;

                const stats = data.stats;
                document.getElementById('statEtudiants').textContent = stats.nb_etudiants_total || 0;
                document.getElementById('statRC').textContent = stats.nb_attestations_a_valider || 0;
                document.getElementById('statRecherche').textContent = stats.nb_etudiants_en_recherche || 0;
                document.getElementById('statEntreprises').textContent = stats.nb_entreprises_partenaires || 0;

            } catch (error) {
                console.error('Erreur stats:', error);
            }
        }

        // ==================== RC : LISTE ====================
        async function loadAttestations() {
            const loading = document.getElementById("rcLoading");
            const empty = document.getElementById("rcEmpty");
            const list = document.getElementById("rcList");

            loading.classList.remove("hidden");
            empty.classList.add("hidden");
            list.innerHTML = "";

            try {
                const res = await fetch(`/api/dashboard/secretaire/attestations?userId=${userId}`);
                const data = await res.json();

                loading.classList.add("hidden");

                if (!data.ok) {
                    console.error(data.error || "Erreur chargement attestations");
                    empty.textContent = "Erreur lors du chargement des attestations.";
                    empty.classList.remove("hidden");
                    return;
                }

                const attestations = data.attestations || [];

                // Badge menu
                const badge = document.getElementById("menuBadgeRC");
                const n = attestations.length;
                if (n > 0) { badge.textContent = String(n); badge.classList.remove("hidden"); }
                else { badge.classList.add("hidden"); }

                if (attestations.length === 0) {
                    empty.classList.remove("hidden");
                    return;
                }

                attestations.forEach(a => {
                    list.appendChild(renderAttestationRow(a));
                });

            } catch (e) {
                loading.classList.add("hidden");
                empty.textContent = "Erreur technique lors du chargement.";
                empty.classList.remove("hidden");
                console.error(e);
            }
        }

        function renderAttestationRow(a) {
            const etudiantId = a.etudiant_id;
            const nom = `${a.prenom || ''} ${a.nom || ''}`.trim() || `Étudiant #${etudiantId}`;
            const promo = a.promo ? `Promo ${a.promo}` : '';
            const dateDepot = a.date_depot ? new Date(a.date_depot).toLocaleDateString('fr-FR') : '—';
            const fichier = a.fichier_url ? shortFileName(a.fichier_url) : 'fichier indisponible';
            const initials = getInitials(a.prenom, a.nom);

            const row = document.createElement("div");
            row.className = "px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition";

            row.innerHTML = `
        <div class="flex items-center space-x-4 flex-1">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                <span class="text-blue-600 font-semibold text-sm">${initials}</span>
            </div>
            <div class="flex-1">
                <h4 class="text-sm font-medium text-gray-900">${escapeHtml(nom)}</h4>
                <p class="text-xs text-gray-500">${escapeHtml(promo)} • Soumis le ${escapeHtml(dateDepot)}</p>
            </div>
            <div class="flex items-center space-x-2">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <span class="text-sm text-gray-600">${escapeHtml(fichier)}</span>
            </div>
        </div>

        <div class="flex items-center space-x-2 ml-4">
            <button data-action="valider" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition">
                Valider
            </button>
            <button data-action="refuser" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition">
                Refuser
            </button>
        </div>
        `;

            row.querySelector('[data-action="valider"]').addEventListener("click", () => onValider(etudiantId));
            row.querySelector('[data-action="refuser"]').addEventListener("click", () => onRefuser(etudiantId));

            return row;
        }
        // ==================== RC : EXPIREES ====================
        async function loadAttestationsExpirees() {
            const loading = document.getElementById("rcExpireesLoading");
            const empty = document.getElementById("rcExpireesEmpty");
            const list = document.getElementById("rcExpireesList");
            const badge = document.getElementById("rcExpireesBadge");

            loading.classList.remove("hidden");
            empty.classList.add("hidden");
            list.innerHTML = "";
            badge.classList.add("hidden");

            try {
                const res = await fetch(`/api/dashboard/secretaire/attestations-expirees?userId=${userId}`);
                const data = await res.json();

                loading.classList.add("hidden");

                if (!data.ok) {
                    console.error(data.error || "Erreur chargement RC expirées");
                    empty.textContent = "Erreur lors du chargement des RC expirées.";
                    empty.classList.remove("hidden");
                    return;
                }

                const items = data.attestations || [];

                if (items.length === 0) {
                    empty.classList.remove("hidden");
                    return;
                }

                badge.textContent = String(items.length);
                badge.classList.remove("hidden");

                items.forEach(a => list.appendChild(renderRcExpireeRow(a)));

            } catch (e) {
                loading.classList.add("hidden");
                empty.textContent = "Erreur technique lors du chargement des RC expirées.";
                empty.classList.remove("hidden");
                console.error(e);
            }
        }

        function renderRcExpireeRow(a) {
            const fullName = `${a.prenom || ''} ${a.nom || ''}`.trim() || (a.email || `Étudiant #${a.etudiant_id}`);
            const initials = getInitials(a.prenom, a.nom);
            const days = Number(a.jours_depuis_expiration) || 0;
            const email = a.email || "";

            const row = document.createElement("div");
            row.className = "px-6 py-4 bg-red-50 flex items-center justify-between";

            row.innerHTML = `
            <div class="flex items-center space-x-4 flex-1">
            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                <span class="text-red-600 font-semibold text-sm">${escapeHtml(initials)}</span>
            </div>
            <div class="flex-1">
                <h4 class="text-sm font-medium text-gray-900">${escapeHtml(fullName)}</h4>
                <p class="text-xs text-red-600 font-medium">⚠️ RC expirée depuis ${escapeHtml(days)} jours</p>
            </div>
            </div>

            <button data-action="contact"
            class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm rounded-lg transition">
            Contacter l'étudiant
            </button>
        `;

            row.querySelector('[data-action="contact"]').addEventListener("click", () => {
                if (!email) return alert("Email indisponible.");
                const subject = encodeURIComponent("Attestation RC expirée - Action requise");
                const body = encodeURIComponent(
                    `Bonjour,\n\nVotre attestation de responsabilité civile est expirée. Merci de déposer une attestation à jour sur Candidapp.\n\nCordialement,\nSecrétariat`
                );
                window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
            });

            return row;
        }

        // ==================== RC : ACTIONS ====================
        async function onValider(etudiantId) {
            if (!confirm("Valider cette attestation RC ?")) return;

            try {
                const res = await fetch(`/api/dashboard/secretaire/attestations/${etudiantId}/valider?userId=${userId}`, {
                    method: "POST"
                });
                const data = await res.json();

                if (!data.ok) {
                    alert(data.error || "Erreur validation");
                    return;
                }

                await loadStats();
                await loadAttestations();
            } catch (e) {
                console.error(e);
                alert("Erreur technique validation");
            }
        }

        async function onRefuser(etudiantId) {
            const motif = prompt("Motif de refus (optionnel) :", "");
            if (motif === null) return;

            try {
                const res = await fetch(`/api/dashboard/secretaire/attestations/${etudiantId}/refuser?userId=${userId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ motif_refus: motif || null })
                });
                const data = await res.json();

                if (!data.ok) {
                    alert(data.error || "Erreur refus");
                    return;
                }

                await loadStats();
                await loadAttestations();
            } catch (e) {
                console.error(e);
                alert("Erreur technique refus");
            }
        }

        // ==================== HELPERS ====================
        function getInitials(prenom, nom) {
            const p = (prenom || "").trim();
            const n = (nom || "").trim();
            return ((p[0] || '') + (n[0] || '')).toUpperCase() || "??";
        }

        function shortFileName(url) {
            try {
                if (typeof url === "string" && url.startsWith("data:")) return "attestation_rc.pdf";
                const parts = String(url).split("/");
                return parts[parts.length - 1] || "attestation_rc.pdf";
            } catch {
                return "attestation_rc.pdf";
            }
        }

        function escapeHtml(str) {
            return String(str ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // ==================== CONGÉS : TOGGLE SIMPLIFIÉ ====================
        const modalConges = document.getElementById('modalConges');
        const btnConges = document.getElementById('btnDeclarerConges');
        const closeModalConges = document.getElementById('closeModalConges');
        const cancelConges = document.getElementById('cancelConges');
        const toggleCongeBtn = document.getElementById('toggleCongeBtn');
        const congeMsg = document.getElementById('congeMsg');

        let currentCongeStatus = false;

        function openCongesModal() {
            modalConges.classList.remove('hidden');
            modalConges.classList.add('flex');
            congeMsg.classList.add('hidden');
            loadCongeStatut();
        }

        function closeCongesModal() {
            modalConges.classList.add('hidden');
            modalConges.classList.remove('flex');
        }

        btnConges?.addEventListener('click', openCongesModal);
        closeModalConges?.addEventListener('click', closeCongesModal);
        cancelConges?.addEventListener('click', closeCongesModal);

        async function loadCongeStatut() {
            const statutText = document.getElementById('congeStatutText');
            const statutBadge = document.getElementById('congeStatutBadge');
            const remplacantsList = document.getElementById('remplacantsList');

            try {
                const r = await fetch(`/api/dashboard/secretaire/conges/statut?userId=${userId}`);
                const data = await r.json();

                if (!data.ok) {
                    statutText.textContent = 'Erreur de chargement';
                    return;
                }

                currentCongeStatus = data.enConge;
                updateCongeUI();

                // Afficher les remplaçants
                const remplacants = data.remplacants || [];
                if (remplacants.length === 0) {
                    remplacantsList.innerHTML = '<p class="text-amber-600">Aucun groupe assigné - pas de remplaçant disponible</p>';
                } else {
                    remplacantsList.innerHTML = remplacants.map(r => `
                    <div class="flex items-center justify-between p-2 bg-white rounded border">
                        <span class="font-medium">${escapeHtml(r.remplacant_nom || 'Enseignant')}</span>
                        <span class="text-xs text-gray-500">${escapeHtml(r.nom_groupe)}</span>
                    </div>
                `).join('');
                }

            } catch (e) {
                console.error(e);
                document.getElementById('congeStatutText').textContent = 'Erreur technique';
            }
        }

        function updateCongeUI() {
            const statutText = document.getElementById('congeStatutText');
            const statutBadge = document.getElementById('congeStatutBadge');
            const statutBox = document.getElementById('congeStatutBox');
            const congeLabel = document.getElementById('congeLabel');
            const btnCongesEl = document.getElementById('btnDeclarerConges');

            if (currentCongeStatus) {
                statutText.textContent = 'Vous êtes en mode congé';
                statutBadge.textContent = 'En congé';
                statutBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-amber-100 text-amber-700';
                statutBox.className = 'p-4 rounded-lg bg-amber-50 border border-amber-200';
                toggleCongeBtn.textContent = 'Désactiver le mode congé';
                toggleCongeBtn.className = 'px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700';
                if (congeLabel) congeLabel.textContent = 'En congé';
                if (btnCongesEl) btnCongesEl.className = 'hidden md:flex items-center space-x-2 bg-amber-500 hover:bg-amber-600 backdrop-blur-sm px-5 py-3 rounded-lg font-semibold transition';
            } else {
                statutText.textContent = 'Vous êtes en activité';
                statutBadge.textContent = 'Actif';
                statutBadge.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700';
                statutBox.className = 'p-4 rounded-lg bg-green-50 border border-green-200';
                toggleCongeBtn.textContent = 'Activer le mode congé';
                toggleCongeBtn.className = 'px-4 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700';
                if (congeLabel) congeLabel.textContent = 'Mode congé';
                if (btnCongesEl) btnCongesEl.className = 'hidden md:flex items-center space-x-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm px-5 py-3 rounded-lg font-semibold transition';
            }
        }

        toggleCongeBtn?.addEventListener('click', async () => {
            const newStatus = !currentCongeStatus;
            congeMsg.classList.remove('hidden');
            congeMsg.className = 'text-sm text-gray-600';
            congeMsg.textContent = 'Mise à jour...';

            try {
                const resp = await fetch(`/api/dashboard/secretaire/conges/toggle?userId=${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enConge: newStatus })
                });

                const data = await resp.json();
                if (!resp.ok || !data.ok) {
                    congeMsg.className = 'text-sm text-red-600';
                    congeMsg.textContent = data.error || 'Erreur lors de la mise à jour.';
                    return;
                }

                currentCongeStatus = data.enConge;
                updateCongeUI();

                congeMsg.className = 'text-sm text-green-600';
                congeMsg.textContent = data.message;

                setTimeout(() => congeMsg.classList.add('hidden'), 3000);
            } catch (e) {
                console.error(e);
                congeMsg.className = 'text-sm text-red-600';
                congeMsg.textContent = 'Erreur technique.';
            }
        });

        // Charger le statut initial au démarrage
        async function loadInitialCongeStatus() {
            try {
                const r = await fetch(`/api/dashboard/secretaire/conges/statut?userId=${userId}`);
                const data = await r.json();
                if (data.ok) {
                    currentCongeStatus = data.enConge;
                    updateCongeUI();
                }
            } catch (e) {
                console.error('Erreur chargement statut congé:', e);
            }
        }
    </script>
    <script src="/js/auth.js"></script>

</body>

</html>