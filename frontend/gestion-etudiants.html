<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestion √âtudiants - Secr√©taire</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { primary: { 600: "#4f46e5", 700: "#4338ca" } } } }
    }
  </script>
  <style>
    .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #a855f7 100%); }
    .sidebar { width: 280px; min-height: 100vh; }
    .menu-item:hover { background-color: rgba(99, 102, 241, 0.1); transform: translateX(4px); transition: .2s; }
    .menu-item.active { background-color: rgba(99, 102, 241, 0.15); border-left: 4px solid #4f46e5; font-weight: 600; }
  </style>
</head>
<body class="bg-gray-50">

<div class="flex">
  <!-- Sidebar -->
  <aside class="sidebar bg-white shadow-lg fixed left-0 top-0 flex flex-col">
    <div class="p-6 border-b">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
          <span class="text-white font-bold text-xl">C</span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-900">Candidapp</h1>
          <p class="text-xs text-gray-500">Secr√©tariat</p>
        </div>
      </div>
    </div>

    <nav class="flex-1 py-6">
      <div class="px-4 space-y-2">
        <a href="/secretaire/dashboard" class="menu-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700">
          <span>üè†</span><span>Tableau de bord</span>
        </a>

        <a href="/secretaire/etudiants" class="menu-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700">
          <span>üë©‚Äçüéì</span><span>Gestion √©tudiants</span>
        </a>

        <a href="/attestation-rc" class="menu-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700">
          <span>‚úÖ</span><span>Validation RC</span>
        </a>
      </div>
    </nav>

    <div class="p-4 border-t">
      <button id="logoutBtn" class="w-full px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 transition">
        D√©connexion
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 ml-[280px]">
    <header class="bg-white shadow-sm sticky top-0 z-10">
      <div class="px-8 py-4">
        <h2 class="text-2xl font-bold text-gray-900">Gestion des √©tudiants</h2>
        <p class="text-sm text-gray-500 mt-1">Cr√©er des comptes √©tudiants (via vue + trigger) et consulter la liste.</p>
      </div>
    </header>

    <div class="p-8 space-y-8">

      <!-- Messages -->
      <div id="msg" class="hidden p-4 rounded-lg"></div>

      <!-- Form cr√©ation -->
      <section class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold mb-4">Cr√©er un compte √©tudiant</h3>

        <form id="createForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600">Nom *</label>
            <input id="nom" class="w-full mt-1 border rounded-lg px-3 py-2" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Pr√©nom *</label>
            <input id="prenom" class="w-full mt-1 border rounded-lg px-3 py-2" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Email *</label>
            <input id="email" type="email" class="w-full mt-1 border rounded-lg px-3 py-2" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Mot de passe *</label>
            <input id="password" type="password" class="w-full mt-1 border rounded-lg px-3 py-2" required minlength="6"/>
          </div>
          <div>
            <label class="text-sm text-gray-600">Formation *</label>
            <input id="formation" class="w-full mt-1 border rounded-lg px-3 py-2" required />
          </div>
          <div>
            <label class="text-sm text-gray-600">Promo</label>
            <input id="promo" class="w-full mt-1 border rounded-lg px-3 py-2" placeholder="ex: 2026" />
          </div>

          <div class="md:col-span-2 flex items-center justify-end gap-3 mt-2">
            <button type="button" id="refreshBtn" class="px-4 py-2 rounded-lg border hover:bg-gray-50">
              Rafra√Æchir liste
            </button>
            <button id="submitBtn" class="px-4 py-2 rounded-lg bg-primary-600 hover:bg-primary-700 text-white font-medium">
              Cr√©er
            </button>
          </div>
        </form>
      </section>

      <!-- Liste -->
      <section class="bg-white rounded-xl shadow-sm p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Liste des √©tudiants</h3>
          <span id="count" class="text-sm text-gray-500">-</span>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-left text-gray-500 border-b">
              <tr>
                <th class="py-2">ID</th>
                <th>Email</th>
                <th>Nom</th>
                <th>Pr√©nom</th>
                <th>Formation</th>
                <th>Promo</th>
                <th>Recherche</th>
                <th>Visible</th>
              </tr>
            </thead>
            <tbody id="tbody" class="divide-y"></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>
</div>

<script>
  const msgEl = document.getElementById('msg');
  function showMsg(text, ok=true) {
    msgEl.classList.remove('hidden');
    msgEl.textContent = text;
    msgEl.className = ok
      ? 'p-4 rounded-lg bg-green-50 text-green-700 border border-green-200'
      : 'p-4 rounded-lg bg-red-50 text-red-700 border border-red-200';
    setTimeout(() => msgEl.classList.add('hidden'), 5000);
  }

  const user = JSON.parse(sessionStorage.getItem('user') || 'null');
  if (!user) window.location.href = '/login';
  if (user && user.role !== 'SECRETAIRE') window.location.href = '/login';

  document.getElementById('logoutBtn').addEventListener('click', () => {
    sessionStorage.removeItem('user');
    window.location.href = '/login';
  });

  async function loadEtudiants() {
    const res = await fetch(`/api/dashboard/secretaire/etudiants?userId=${user.id}`);
    const data = await res.json();
    if (!res.ok) {
      showMsg(data.error || 'Erreur chargement √©tudiants', false);
      return;
    }

    const etudiants = data.etudiants || [];
    document.getElementById('count').textContent = `${etudiants.length} √©tudiant(s)`;
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    for (const e of etudiants) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-2">${e.etudiant_id ?? '-'}</td>
        <td>${e.email ?? '-'}</td>
        <td>${e.nom ?? '-'}</td>
        <td>${e.prenom ?? '-'}</td>
        <td>${e.formation ?? '-'}</td>
        <td>${e.promo ?? '-'}</td>
        <td>${e.en_recherche === true ? '‚úÖ' : '‚ùå'}</td>
        <td>${e.profil_visible === true ? '‚úÖ' : '‚ùå'}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', loadEtudiants);

  document.getElementById('createForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;

    const payload = {
      nom: document.getElementById('nom').value.trim(),
      prenom: document.getElementById('prenom').value.trim(),
      email: document.getElementById('email').value.trim(),
      password: document.getElementById('password').value,
      formation: document.getElementById('formation').value.trim(),
      promo: document.getElementById('promo').value.trim() || null
    };

    try {
      const res = await fetch(`/api/dashboard/secretaire/etudiants?userId=${user.id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) {
        showMsg(data.error || 'Erreur cr√©ation √©tudiant', false);
        submitBtn.disabled = false;
        return;
      }

      showMsg(`Cr√©√© ‚úÖ utilisateurId=${data.utilisateurId} / etudiantId=${data.etudiantId}`, true);
      document.getElementById('createForm').reset();
      await loadEtudiants();

    } catch (err) {
      showMsg('Erreur r√©seau / serveur', false);
    } finally {
      submitBtn.disabled = false;
    }
  });

  // init
  loadEtudiants();
</script>
</body>
</html>
